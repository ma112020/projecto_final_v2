name: CI/CD Pipeline Principal

on:
  push:
    # Este workflow será disparado em qualquer push para estes ramos
    branches:
      - main
      - develop
      - staging
  pull_request:
    # Este workflow será disparado em qualquer PR direcionado a estes ramos
    branches:
      - main
      - develop
  
  workflow_dispatch:
  # Adiconada a execução manual do pipeline através da UI (Workflow_dispatch)
    inputs:
      branch:
        description: 'Ramo para executar o workflow (ex: staging, develop)'
        required: true
        default: 'staging'

jobs:
  test_and_build:
    runs-on: ubuntu-latest

    # Variáveis de ambiente
    env:
      # A CHAVE DA GEMINI API é necessária para os testes de integração do 'products' service
      API_KEY_GEMINI: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout Código Fonte
        uses: actions/checkout@v4

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Instalar Dependências e Ferramentas (via pip)
        # As dependências são instaladas a partir do caminho corrigido (app/requirements.txt)
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt

      - name: Executar Linting (Flake8) e Testes Pytest
        # O 'make test_dev' executa 'lint' e 'pytest -m "dev"', verificando qualidade e funcionalidade
        run: make test_dev

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login no Docker Hub (Opcional, se for necessário push)
        # Remova ou ajuste, dependendo se faz push de imagens para um registry
        # uses: docker/login-action@v3
        # with:
        #   username: ${{ secrets.DOCKER_USERNAME }}
        #   password: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "Login no Docker Hub ignorado, apenas build local."

      - name: Construir Imagens Docker (Users e Products)
        # Usa o 'make build' que foi corrigido para 'docker compose build'
        run: make build
        
      # --------------------------------------------------------------------------
      # PASSO DE SEGURANÇA (SAST) - ANÁLISE ESTÁTICA
      # Idealmente executado em 'staging' ou 'main' antes de qualquer deployment.
      # Usamos o Bandit (que já está no seu requirements.txt)
      - name: Análise Estática de Segurança (Bandit - SAST)
        if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
        run: |
          bandit -r app/ -c .bandit-config.yml || true # Use '-c' se tiver um ficheiro config

      # --------------------------------------------------------------------------
      # PASSO DE DAST (OWASP ZAP) - ANÁLISE DINÂMICA
      # Este passo deve ser feito num ambiente que corra o docker-compose, 
      # mas é mais complexo e pode ser adicionado num job separado
      # --------------------------------------------------------------------------

      - name: Confirmação de Build e Teste
        run: |
          echo "Pipeline de CI concluído com sucesso. Imagens construídas."
          echo "Pronto para Deploy/DAST no ambiente staging/main."